#include "pch.h"
#include "CppUnitTest.h"
#include "TestHelpers.h"
#include "../MesSolverLib/MesSolver.h"
#include <filesystem>

using namespace Microsoft::VisualStudio::CppUnitTestFramework;

namespace Tests
{
	const double epsilon = 0.1;

	TEST_CLASS(MesSolverTest)
	{
	public:
		TEST_METHOD(SimpleGrid4x4Test)
		{
			std::vector<std::vector<double>> validMatrixHbc =
			{
				{23.3333, -2.5, 0, 0, -2.5, -8.33333, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
				{-2.5, 40, -2.5, 0, -8.33333, -8.33333, -8.33333, 0, 0, 0, 0, 0, 0, 0, 0, 0},
				{0, -2.5, 40, -2.5, 0, -8.33333, -8.33333, -8.33333, 0, 0, 0, 0, 0, 0, 0, 0},
				{0, 0, -2.5, 23.3333, 0, 0, -8.33333, -2.5, 0, 0, 0, 0, 0, 0, 0, 0},
				{-2.5, -8.33333, 0, 0, 40, -8.33334, 0, 0, -2.5, -8.33333, 0, 0, 0, 0, 0, 0},
				{-8.33333, -8.33333, -8.33333, 0, -8.33334, 66.6667, -8.33333, 0, -8.33333, -8.33333, -8.33333, 0, 0, 0, 0, 0},
				{0, -8.33333, -8.33333, -8.33333, 0, -8.33333, 66.6667, -8.33333, 0, -8.33333, -8.33333, -8.33333, 0, 0, 0, 0},
				{0, 0, -8.33333, -2.5, 0, 0, -8.33333, 40, 0, 0, -8.33333, -2.5, 0, 0, 0, 0},
				{0, 0, 0, 0, -2.5, -8.33333, 0, 0, 40, -8.33333, 0, 0, -2.5, -8.33333, 0, 0},
				{0, 0, 0, 0, -8.33333, -8.33333, -8.33333, 0, -8.33333, 66.6667, -8.33333, 0, -8.33333, -8.33333, -8.33333, 0},
				{0, 0, 0, 0, 0, -8.33333, -8.33333, -8.33333, 0, -8.33333, 66.6667, -8.33333, 0, -8.33333, -8.33334, -8.33333},
				{0, 0, 0, 0, 0, 0, -8.33333, -2.5, 0, 0, -8.33333, 40, 0, 0, -8.33333, -2.5},
				{0, 0, 0, 0, 0, 0, 0, 0, -2.5, -8.33333, 0, 0, 23.3333, -2.5, 0, 0},
				{0, 0, 0, 0, 0, 0, 0, 0, -8.33333, -8.33333, -8.33333, 0, -2.5, 40, -2.5, 0},
				{0, 0, 0, 0, 0, 0, 0, 0, 0, -8.33333, -8.33334, -8.33333, 0, -2.5, 40, -2.5},
				{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -8.33333, -2.5, 0, 0, -2.5, 23.3333}
			};

			std::vector<double> validVectorP = {
				12000, 12000, 12000, 12000, 12000, 0, 0, 12000, 12000, 0, 0, 12000, 12000, 12000, 12000, 12000
			};

			std::vector<std::vector<double>> validMatrixC =
			{
				{674.074, 337.037, 0, 0, 337.037, 168.519, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
				{337.037, 1348.15, 337.037, 0, 168.519, 674.074, 168.519, 0, 0, 0, 0, 0, 0, 0, 0, 0},
				{0, 337.037, 1348.15, 337.037, 0, 168.519, 674.074, 168.519, 0, 0, 0, 0, 0, 0, 0, 0},
				{0, 0, 337.037, 674.074, 0, 0, 168.519, 337.037, 0, 0, 0, 0, 0, 0, 0, 0},
				{337.037, 168.519, 0, 0, 1348.15, 674.074, 0, 0, 337.037, 168.519, 0, 0, 0, 0, 0, 0},
				{168.519, 674.074, 168.519, 0, 674.074, 2696.3, 674.074, 0, 168.519, 674.074, 168.519, 0, 0, 0, 0, 0},
				{0, 168.519, 674.074, 168.519, 0, 674.074, 2696.3, 674.074, 0, 168.519, 674.074, 168.519, 0, 0, 0, 0},
				{0, 0, 168.519, 337.037, 0, 0, 674.074, 1348.15, 0, 0, 168.519, 337.037, 0, 0, 0, 0},
				{0, 0, 0, 0, 337.037, 168.519, 0, 0, 1348.15, 674.074, 0, 0, 337.037, 168.519, 0, 0},
				{0, 0, 0, 0, 168.519, 674.074, 168.519, 0, 674.074, 2696.3, 674.074, 0, 168.519, 674.074, 168.519, 0},
				{0, 0, 0, 0, 0, 168.519, 674.074, 168.519, 0, 674.074, 2696.3, 674.074, 0, 168.519, 674.074, 168.519},
				{0, 0, 0, 0, 0, 0, 168.519, 337.037, 0, 0, 674.074, 1348.15, 0, 0, 168.519, 337.037},
				{0, 0, 0, 0, 0, 0, 0, 0, 337.037, 168.519, 0, 0, 674.074, 337.037, 0, 0},
				{0, 0, 0, 0, 0, 0, 0, 0, 168.519, 674.074, 168.519, 0, 337.037, 1348.15, 337.037, 0},
				{0, 0, 0, 0, 0, 0, 0, 0, 0, 168.519, 674.074, 168.519, 0, 337.037, 1348.15, 337.037},
				{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 168.519, 337.037, 0, 0, 337.037, 674.074}
			};

			std::vector<std::vector<double>> validMinMaxTemps = {
				{110.03797659406167, 365.8154705784631},
				{168.83701715655656, 502.5917120896439},
				{242.80085524391868, 587.372666691486},
				{318.61459376004086, 649.3874834542602},
				{391.2557916738893, 700.0684204214381},
				{459.03690325635404, 744.0633443187048},
				{521.5862742337766, 783.382849723737},
				{579.0344449687701, 818.9921876836681},
				{631.6892368621455, 851.4310425916341},
				{679.9075931513394, 881.057634906017}
			};

			MesSolver solver(2, false);
			Assert::IsTrue(solver.LoadData("Test1_4_4.txt"));
			solver.CalculateTimeIndependentVariables();

			Assert::IsTrue(TestHelpers::AreMatricesEqual(solver.GetMatrixH(), validMatrixHbc, epsilon));
			Assert::IsTrue(TestHelpers::AreVectorsEqual(solver.GetVectorP(), validVectorP, epsilon));
			Assert::IsTrue(TestHelpers::AreMatricesEqual(solver.GetMatrixC(), validMatrixC, epsilon));

			std::vector<std::vector<double>> minMaxTemps;
			std::vector<std::vector<double>> resultTemps = solver.SimulateWithTime();
			for (const auto& row : resultTemps)
				minMaxTemps.push_back({ *std::min_element(row.begin(), row.end()), *std::max_element(row.begin(), row.end()) });

			Assert::IsTrue(TestHelpers::AreMatricesEqual(minMaxTemps, validMinMaxTemps, epsilon));
		}

		TEST_METHOD(MixGrid4x4Test)
		{
			std::vector<std::vector<double>> validMatrixHbc =
			{
				{26.824,   -1.13431,  0.0,       0.0,      -1.13431, -10.963,   0.0,       0.0,       0.0,      0.0,       0.0,       0.0,      0.0,       0.0,       0.0,      0.0},
				{-1.13431, 43.3438,  -3.58878,  0.0,      -6.10152, -7.64516, -13.2722,   0.0,       0.0,      0.0,       0.0,       0.0,      0.0,       0.0,       0.0,      0.0},
				{0.0,      -3.58878, 40.7351,  -4.35854,  0.0,      -4.50181, -7.71486,  -12.3674,   0.0,      0.0,       0.0,       0.0,      0.0,       0.0,       0.0,      0.0},
				{0.0,       0.0,     -4.35854, 20.7445,   0.0,       0.0,     -5.23115,  -4.35854,   0.0,      0.0,       0.0,       0.0,      0.0,       0.0,       0.0,      0.0},
				{-1.13431, -6.10152,  0.0,      0.0,      43.3438,  -7.64516,  0.0,       0.0,      -3.58878, -13.2722,   0.0,       0.0,      0.0,       0.0,       0.0,      0.0},
				{-10.963,  -7.64516, -4.50181,  0.0,      -7.64516, 71.0151,  -10.2767,   0.0,      -4.50181, -10.2767,  -15.2049,   0.0,      0.0,       0.0,       0.0,      0.0},
				{0.0,     -13.2722,  -7.71486, -5.23115,  0.0,     -10.2767,  71.0237,   -7.71486,   0.0,     -3.26505,  -10.2767,  -13.2722,  0.0,       0.0,       0.0,      0.0},
				{0.0,       0.0,    -12.3674,  -4.35854,  0.0,       0.0,     -7.71486,  40.7351,    0.0,      0.0,      -4.50181,  -3.58878,  0.0,       0.0,       0.0,      0.0},
				{0.0,       0.0,     0.0,       0.0,     -3.58878, -4.50181,   0.0,       0.0,      40.7351,  -7.71486,   0.0,       0.0,     -4.35854,  -12.3674,   0.0,      0.0},
				{0.0,       0.0,     0.0,       0.0,    -13.2722, -10.2767,  -3.26505,   0.0,      -7.71486,  71.0237,  -10.2767,    0.0,     -5.23115,  -7.71486,  -13.2722,  0.0},
				{0.0,       0.0,     0.0,       0.0,      0.0,    -15.2049, -10.2767,   -4.50181,   0.0,     -10.2767,   71.0151,   -7.64516,  0.0,      -4.50181,  -7.64516, -10.963},
				{0.0,       0.0,     0.0,       0.0,      0.0,      0.0,    -13.2722,   -3.58878,   0.0,      0.0,      -7.64516,   43.3438,  0.0,       0.0,      -6.10152, -1.13431},
				{0.0,       0.0,     0.0,       0.0,      0.0,      0.0,      0.0,       0.0,      -4.35854, -5.23115,   0.0,        0.0,     20.7445,   -4.35854,   0.0,      0.0},
				{0.0,       0.0,     0.0,       0.0,      0.0,      0.0,      0.0,       0.0,     -12.3674,  -7.71486,  -4.50181,    0.0,     -4.35854,  40.7351,   -3.58878,  0.0},
				{0.0,       0.0,     0.0,       0.0,      0.0,      0.0,      0.0,       0.0,       0.0,    -13.2722,   -7.64516,   -6.10152,  0.0,      -3.58878,   43.3438, -1.13431},
				{0.0,       0.0,     0.0,       0.0,      0.0,      0.0,      0.0,       0.0,       0.0,      0.0,     -10.963,    -1.13431,  0.0,       0.0,      -1.13431, 26.824}
			};


			std::vector<double> validVectorP = {
				16310.9, 13922.3, 9844.53, 8155.47,
				13922.3, 0.0, 0.0, 9844.53,
				9844.53, 0.0, 0.0, 13922.3,
				8155.47, 9844.53, 13922.3, 16310.9
			};


			/*std::vector<std::vector<double>> validMatrixC = {
				{674.074, 337.037, 0.0, 0.0, 337.037, 168.519, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
				{337.037, 1348.15, 337.037, 0.0, 168.519, 674.074, 168.519, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
				{0.0, 337.037, 1348.15, 337.037, 0.0, 168.519, 674.074, 168.519, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
				{0.0, 0.0, 337.037, 674.074, 0.0, 0.0, 168.519, 337.037, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
				{337.037, 168.519, 0.0, 0.0, 1348.15, 674.074, 0.0, 0.0, 337.037, 168.519, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
				{168.519, 674.074, 168.519, 0.0, 674.074, 2696.3, 674.074, 0.0, 168.519, 674.074, 168.519, 0.0, 0.0, 0.0, 0.0, 0.0},
				{0.0, 168.519, 674.074, 168.519, 0.0, 674.074, 2696.3, 674.074, 0.0, 168.519, 674.074, 168.519, 0.0, 0.0, 0.0, 0.0},
				{0.0, 0.0, 168.519, 337.037, 0.0, 0.0, 674.074, 1348.15, 0.0, 0.0, 168.519, 337.037, 0.0, 0.0, 0.0, 0.0},
				{0.0, 0.0, 0.0, 0.0, 337.037, 168.519, 0.0, 0.0, 1348.15, 674.074, 0.0, 0.0, 337.037, 168.519, 0.0, 0.0},
				{0.0, 0.0, 0.0, 0.0, 168.519, 674.074, 168.519, 0.0, 674.074, 2696.3, 674.074, 0.0, 168.519, 674.074, 168.519, 0.0},
				{0.0, 0.0, 0.0, 0.0, 0.0, 168.519, 674.074, 168.519, 0.0, 674.074, 2696.3, 674.074, 0.0, 168.519, 674.074, 168.519},
				{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 168.519, 337.037, 0.0, 0.0, 674.074, 1348.15, 0.0, 0.0, 168.519, 337.037},
				{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 337.037, 168.519, 0.0, 0.0, 674.074, 337.037, 0.0, 0.0},
				{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 168.519, 674.074, 168.519, 0.0, 337.037, 1348.15, 337.037, 0.0},
				{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 168.519, 674.074, 168.519, 0.0, 337.037, 1348.15, 337.037},
				{0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 168.519, 337.037, 0.0, 0.0, 337.037, 674.074}
			};*/

			std::vector<std::vector<double>> validMinMaxTemps = {
				{95.15184673458245, 374.6863325385064},
				{147.64441665454345, 505.96811082245307},
				{220.1644549730314, 586.9978503916302},
				{296.7364399006366, 647.28558387732},
				{370.968275802604, 697.3339863103786},
				{440.5601440058566, 741.2191121514377},
				{504.8911996551285, 781.209569726045},
				{564.0015111915015, 817.3915065469778},
				{618.1738556427995, 850.2373194670416},
				{667.7655470268747, 880.1676054000437}
			};

			MesSolver solver(2, false);
			Assert::IsTrue(solver.LoadData("Test2_4_4_MixGrid.txt"));
			solver.CalculateTimeIndependentVariables();

			Assert::IsTrue(TestHelpers::AreMatricesEqual(solver.GetMatrixH(), validMatrixHbc, epsilon));
			Assert::IsTrue(TestHelpers::AreVectorsEqual(solver.GetVectorP(), validVectorP, epsilon));
			//Assert::IsTrue(TestHelpers::AreMatricesEqual(solver.GetMatrixC(), validMatrixC, epsilon));

			std::vector<std::vector<double>> minMaxTemps;
			std::vector<std::vector<double>> resultTemps = solver.SimulateWithTime();
			for (const auto& row : resultTemps)
				minMaxTemps.push_back({ *std::min_element(row.begin(), row.end()), *std::max_element(row.begin(), row.end()) });

			Assert::IsTrue(TestHelpers::AreMatricesEqual(minMaxTemps, validMinMaxTemps, epsilon));
		}
	};
}
